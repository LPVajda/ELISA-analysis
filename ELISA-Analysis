# Load necessary libraries (they have to be installed ofc)
library(tidyverse)
library(ggplot2)
library(dplyr)

# Load calibration and measurement data from text files
calibration <- read.delim("elisa_CAL.txt", header = TRUE, sep = "\t")
measurements <- read.delim("Elisa_measurement.txt", header = TRUE, sep = "\t")

# Rename measurement columns
colnames(measurements) <- c("Source", "ud", "1:3", "1:10", "1:30")

# --- Calibration Curve Processing ---

# Remove outlier from the 8th row in ABS_1
calibration[8, "ABS_1"] <- NA

# Calculate average absorbance from ABS_1 and ABS_2
calibration <- calibration |> 
  mutate(ABS_AVG = rowMeans(select(., ABS_1, ABS_2), na.rm = TRUE))

# Set the zero absorbance as the 8th sample (background)
calibration <- calibration |> 
  mutate(ABS_AVG_norm = ABS_AVG - calibration[8, "ABS_AVG"])

# Linear regression model: Concentration ~ Normalized Absorbance
model <- lm(Concentration ~ ABS_AVG_norm, data = calibration)

# Extract model coefficients and R² value
intercept <- round(coef(model)[1], 2)
slope <- round(coef(model)[2], 2)
r_squared <- round(summary(model)$r.squared, 3)

# Generate regression equation as text
equation <- paste0("y = ", slope, "x + ", intercept, " (R² = ", r_squared, ")")

# Plot standard curve with equation
ggplot(calibration, aes(x = ABS_AVG_norm, y = Concentration)) +
  geom_point(color = "blue", size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linetype = "dashed") +
  annotate("text", x = min(calibration$ABS_AVG_norm), y = max(calibration$Concentration), 
           label = equation, hjust = 0, size = 5) +
  labs(
    title = "Standard Curve for IL-8",
    x = "Normalized Absorbance (ABS_AVG_norm)",
    y = "Concentration (pg/mL)"
  ) +
  theme_minimal()

# --- Concentration Calculation ---

# Apply standard curve equation to measurements
concentration_calc <- measurements |> 
  mutate(across(c("ud", "1:3", "1:10", "1:30"), ~ .x * slope + intercept))

# --- Calculate Mean and Standard Deviation ---

# Create row ID for grouping every two rows (duplicates)
concentration_calc_avg <- concentration_calc |> 
  mutate(RowID = row_number()) |> 
  group_by(Group = (RowID + 1) %/% 2) |> 
  summarise(
    Source = first(Source),
    across(c("ud", "1:3", "1:10", "1:30"), list(
      Mean = mean,
      SD = sd
    )),
    .groups = "drop"
  ) |> 
  select(-Group)

# --- Prepare Data for Plotting ---

# Reshape data into long format for plotting
concentration_long_summary <- concentration_calc_avg |> 
  pivot_longer(
    cols = -Source,
    names_to = c("Dilution", ".value"),
    names_sep = "_"
  )

# Ensure dilution levels are ordered correctly
concentration_long_summary <- concentration_long_summary |> 
  mutate(Dilution = factor(Dilution, levels = c("1:30", "1:10", "1:3", "ud")))

# --- Plotting ---

# Plot bar chart with error bars (Mean + SD) separated by Source (facet)
ggplot(concentration_long_summary, aes(x = Dilution, y = Mean, fill = Source)) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.9) +
  geom_errorbar(
    aes(ymin = Mean - SD, ymax = Mean + SD),
    width = 0.2,
    position = position_dodge(0.9)
  ) +
  facet_wrap(~ Source, scales = "free_y") +
  labs(
    title = "IL-8 Concentrations with Standard Deviation",
    x = "Dilution",
    y = "Concentration (pg/mL)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
